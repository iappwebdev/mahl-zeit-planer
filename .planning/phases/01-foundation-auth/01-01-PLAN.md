---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - angular.json
  - package.json
  - tsconfig.json
  - tsconfig.app.json
  - src/app/app.config.ts
  - src/app/app.component.ts
  - src/environments/environment.ts
  - src/environments/environment.prod.ts
  - src/app/core/services/supabase.service.ts
  - src/styles.css
  - supabase/migrations/001_profiles.sql
  - .env.example
autonomous: true
user_setup:
  - service: supabase
    why: "Authentication and database backend"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Create a new Supabase project (or use existing)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable email confirmation in Auth settings"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Confirm email = ON"
      - task: "Add Site URL for email redirects"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL = http://localhost:4200"
      - task: "Add redirect URL for local development"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs -> Add http://localhost:4200/**"

must_haves:
  truths:
    - "Angular dev server starts without errors on localhost:4200"
    - "Tailwind CSS utility classes render correctly in browser"
    - "Supabase client initializes with environment credentials"
    - "Database profiles table exists with RLS enabled and policies active"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies including Angular, Supabase JS, Tailwind"
      contains: "@supabase/supabase-js"
    - path: "src/app/core/services/supabase.service.ts"
      provides: "Centralized Supabase client with auth methods"
      exports: ["SupabaseService"]
    - path: "src/environments/environment.ts"
      provides: "Supabase URL and anon key configuration"
      contains: "supabaseUrl"
    - path: "supabase/migrations/001_profiles.sql"
      provides: "Profiles table schema with RLS policies"
      contains: "ENABLE ROW LEVEL SECURITY"
  key_links:
    - from: "src/app/core/services/supabase.service.ts"
      to: "src/environments/environment.ts"
      via: "import environment config"
      pattern: "environment\\.supabase"
---

<objective>
Scaffold the Angular 21 project, install and configure Supabase client and Tailwind CSS, set up environment files for Supabase credentials, and create the database schema with Row Level Security enabled.

Purpose: Establish the complete development infrastructure so auth pages, app shell, and all future features have a working foundation to build on.
Output: A running Angular dev server with Supabase client service, Tailwind CSS styling, and a migration-ready database schema.
</objective>

<execution_context>
@C:/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Angular project with Supabase and Tailwind</name>
  <files>
    angular.json
    package.json
    tsconfig.json
    tsconfig.app.json
    src/styles.css
    .env.example
  </files>
  <action>
    1. Create new Angular 21 project using `ng new mahl-zeit-planer --style=css --ssr=false --routing --skip-git` in the project root (run from parent directory, then move contents up, or use `--directory=.` if supported). The project name should be `mahl-zeit-planer`. Use standalone components (Angular 21 default). Skip SSR — this is a client-side SPA deployed on Vercel.

    2. Install dependencies:
       ```
       npm install @supabase/supabase-js
       ```

    3. Add Tailwind CSS v4 via Angular CLI:
       ```
       ng add tailwindcss
       ```
       If `ng add` is not available for Tailwind v4, install manually:
       ```
       npm install -D tailwindcss @tailwindcss/postcss postcss
       ```
       Then configure postcss and add Tailwind imports to `src/styles.css`:
       ```css
       @import "tailwindcss";
       ```

    4. In `angular.json`, set `sourceLocale` to `"de"` under the project's `i18n` configuration. This ensures the app is German by default.

    5. Create `.env.example` with placeholder values (NOT real credentials):
       ```
       SUPABASE_URL=https://your-project.supabase.co
       SUPABASE_ANON_KEY=your-anon-key-here
       ```

    6. Verify the dev server starts: `ng serve` should compile without errors and open on http://localhost:4200.
  </action>
  <verify>
    Run `ng serve` — dev server starts on port 4200 without compilation errors.
    Run `npm ls @supabase/supabase-js` — package is installed.
    Run `npm ls tailwindcss` — package is installed.
    Check `src/styles.css` contains Tailwind import directive.
    Check `.env.example` exists with SUPABASE_URL and SUPABASE_ANON_KEY placeholders.
  </verify>
  <done>
    Angular 21 project scaffolded with standalone components, Supabase JS client installed, Tailwind CSS configured and rendering utility classes, German locale set, and .env.example documenting required environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase service and environment configuration</name>
  <files>
    src/environments/environment.ts
    src/environments/environment.prod.ts
    src/app/core/services/supabase.service.ts
    src/app/app.config.ts
  </files>
  <action>
    1. Create `src/environments/environment.ts` with development config:
       ```typescript
       export const environment = {
         production: false,
         supabaseUrl: 'YOUR_SUPABASE_URL',
         supabaseKey: 'YOUR_SUPABASE_ANON_KEY',
       };
       ```
       Note: For local development, the user will replace these placeholders with real values from their Supabase dashboard. These are client-safe anon keys (not secret keys).

    2. Create `src/environments/environment.prod.ts` with production config:
       ```typescript
       export const environment = {
         production: true,
         supabaseUrl: 'YOUR_SUPABASE_URL',
         supabaseKey: 'YOUR_SUPABASE_ANON_KEY',
       };
       ```
       Note: For Vercel deployment, these will be replaced via environment variables in a later phase.

    3. Configure `angular.json` file replacements so environment.prod.ts replaces environment.ts in production builds. This should already be set up by `ng new` but verify it exists.

    4. Create `src/app/core/services/supabase.service.ts`:
       - Injectable service with `providedIn: 'root'` (singleton)
       - Initialize Supabase client in constructor using `createClient(environment.supabaseUrl, environment.supabaseKey)`
       - Expose methods: `signUp(email, password)`, `signIn(email, password)`, `signOut()`, `getUser()`, `getSession()`, `onAuthStateChange(callback)`
       - Expose `client` getter for direct Supabase access (needed for future DB queries)
       - Use `(select auth.uid())` pattern in any server-side usage hints/comments per research RLS optimization
       - Import from `@supabase/supabase-js` — use types `SupabaseClient`, `User`, `Session`, `AuthChangeEvent`

    5. Ensure `src/app/app.config.ts` uses `provideRouter` and `provideHttpClient` (HttpClient needed for future API calls). Import routes from a new `app.routes.ts` (create empty routes array for now):
       ```typescript
       import { ApplicationConfig } from '@angular/core';
       import { provideRouter } from '@angular/router';
       import { provideHttpClient } from '@angular/common/http';
       import { routes } from './app.routes';

       export const appConfig: ApplicationConfig = {
         providers: [provideRouter(routes), provideHttpClient()]
       };
       ```

    6. Create `src/app/app.routes.ts` with an empty routes array:
       ```typescript
       import { Routes } from '@angular/router';
       export const routes: Routes = [];
       ```
  </action>
  <verify>
    Run `ng serve` — no compilation errors.
    Run `grep -r "supabaseUrl" src/environments/` — both environment files contain the key.
    Run `grep -r "SupabaseService" src/app/core/` — service file exists with proper methods.
    Check that `app.config.ts` imports provideRouter and provideHttpClient.
  </verify>
  <done>
    SupabaseService is a root-provided singleton with signUp, signIn, signOut, getUser, getSession, and onAuthStateChange methods. Environment files hold Supabase URL and anon key for dev and prod. App config wires router and HTTP client.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database schema with RLS policies</name>
  <files>
    supabase/migrations/001_profiles.sql
  </files>
  <action>
    1. Create `supabase/migrations/001_profiles.sql` with the following SQL:

    a. **Profiles table** linked to auth.users:
       ```sql
       CREATE TABLE public.profiles (
         id UUID NOT NULL REFERENCES auth.users ON DELETE CASCADE,
         display_name TEXT,
         created_at TIMESTAMPTZ DEFAULT NOW(),
         updated_at TIMESTAMPTZ DEFAULT NOW(),
         PRIMARY KEY (id)
       );
       ```

    b. **Enable RLS immediately** (CRITICAL — before any data):
       ```sql
       ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
       ```

    c. **RLS policies** using `(SELECT auth.uid())` wrapper for 94-99% performance improvement:
       ```sql
       -- Users can read their own profile
       CREATE POLICY "Users can view own profile"
       ON public.profiles FOR SELECT
       TO authenticated
       USING ((SELECT auth.uid()) = id);

       -- Users can update their own profile
       CREATE POLICY "Users can update own profile"
       ON public.profiles FOR UPDATE
       TO authenticated
       USING ((SELECT auth.uid()) = id)
       WITH CHECK ((SELECT auth.uid()) = id);

       -- Users can insert their own profile (for trigger)
       CREATE POLICY "Users can insert own profile"
       ON public.profiles FOR INSERT
       TO authenticated
       WITH CHECK ((SELECT auth.uid()) = id);
       ```

    d. **Performance index** on the RLS policy column:
       ```sql
       CREATE INDEX idx_profiles_id ON public.profiles(id);
       ```

    e. **Auto-create profile trigger** on user signup:
       ```sql
       CREATE OR REPLACE FUNCTION public.handle_new_user()
       RETURNS TRIGGER
       LANGUAGE plpgsql
       SECURITY DEFINER
       SET search_path = ''
       AS $$
       BEGIN
         INSERT INTO public.profiles (id, display_name)
         VALUES (
           NEW.id,
           COALESCE(NEW.raw_user_meta_data->>'display_name', split_part(NEW.email, '@', 1))
         );
         RETURN NEW;
       END;
       $$;

       CREATE TRIGGER on_auth_user_created
         AFTER INSERT ON auth.users
         FOR EACH ROW
         EXECUTE FUNCTION public.handle_new_user();
       ```

    f. **Updated_at trigger** for automatic timestamp updates:
       ```sql
       CREATE OR REPLACE FUNCTION public.update_updated_at()
       RETURNS TRIGGER
       LANGUAGE plpgsql
       AS $$
       BEGIN
         NEW.updated_at = NOW();
         RETURN NEW;
       END;
       $$;

       CREATE TRIGGER profiles_updated_at
         BEFORE UPDATE ON public.profiles
         FOR EACH ROW
         EXECUTE FUNCTION public.update_updated_at();
       ```

    2. Add a comment at the top of the migration file documenting that this must be run in the Supabase SQL Editor or via Supabase CLI before any users register.

    3. Note: The user will need to run this SQL manually in the Supabase Dashboard SQL Editor, or via `supabase db push` if using Supabase CLI locally. This migration file serves as the source of truth for the schema.
  </action>
  <verify>
    File `supabase/migrations/001_profiles.sql` exists.
    File contains `ENABLE ROW LEVEL SECURITY`.
    File contains `(SELECT auth.uid())` pattern (not raw `auth.uid()`).
    File contains `CREATE INDEX` for performance.
    File contains `handle_new_user` trigger function.
    File contains `SECURITY DEFINER` on the trigger function (required for inserting into profiles from auth context).
  </verify>
  <done>
    Database migration file defines profiles table with RLS enabled, 3 policies (SELECT/UPDATE/INSERT for authenticated users using optimized auth.uid() pattern), performance index, auto-profile-creation trigger on signup, and updated_at timestamp trigger. Ready to execute in Supabase SQL Editor.
  </done>
</task>

</tasks>

<verification>
1. `ng serve` starts without errors on localhost:4200
2. Tailwind utility classes render (add a test class like `text-green-500` to app.component.html temporarily)
3. `SupabaseService` compiles and is injectable (imported in app.config.ts without errors)
4. Environment files contain supabaseUrl and supabaseKey
5. Migration SQL file is syntactically valid and contains all security measures (RLS, policies, indexes)
6. `.env.example` documents required environment variables
</verification>

<success_criteria>
- Angular 21 dev server runs on localhost:4200
- Supabase JS client is installed and SupabaseService provides auth methods
- Tailwind CSS is configured and utility classes work
- Database migration file has RLS enabled with optimized policies
- Environment configuration supports dev and prod targets
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
