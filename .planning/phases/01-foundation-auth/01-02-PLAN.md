---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/core/guards/auth.guard.ts
  - src/app/core/guards/guest.guard.ts
  - src/app/features/auth/login/login.component.ts
  - src/app/features/auth/login/login.component.html
  - src/app/features/auth/register/register.component.ts
  - src/app/features/auth/register/register.component.html
  - src/app/features/auth/confirm-email/confirm-email.component.ts
  - src/app/features/auth/confirm-email/confirm-email.component.html
  - src/app/features/auth/reset-password/reset-password.component.ts
  - src/app/features/auth/reset-password/reset-password.component.html
autonomous: true

must_haves:
  truths:
    - "User can fill in email and password on register page and submit"
    - "After registration, user sees a confirmation page telling them to check their email"
    - "User can fill in email and password on login page and submit"
    - "Invalid form inputs show red inline error messages below the respective fields"
    - "User can navigate between login and register pages"
    - "User can request password reset from login page"
  artifacts:
    - path: "src/app/features/auth/login/login.component.ts"
      provides: "Login form with email/password and Supabase signIn"
      exports: ["LoginComponent"]
    - path: "src/app/features/auth/register/register.component.ts"
      provides: "Registration form with email/password and Supabase signUp"
      exports: ["RegisterComponent"]
    - path: "src/app/features/auth/confirm-email/confirm-email.component.ts"
      provides: "Post-registration confirmation page"
      exports: ["ConfirmEmailComponent"]
    - path: "src/app/core/guards/auth.guard.ts"
      provides: "Route guard redirecting unauthenticated users to login"
      exports: ["authGuard"]
    - path: "src/app/core/guards/guest.guard.ts"
      provides: "Route guard redirecting authenticated users away from auth pages"
      exports: ["guestGuard"]
  key_links:
    - from: "src/app/features/auth/login/login.component.ts"
      to: "src/app/core/services/supabase.service.ts"
      via: "inject(SupabaseService) for signIn"
      pattern: "supabase.*signIn"
    - from: "src/app/features/auth/register/register.component.ts"
      to: "src/app/core/services/supabase.service.ts"
      via: "inject(SupabaseService) for signUp"
      pattern: "supabase.*signUp"
    - from: "src/app/core/guards/auth.guard.ts"
      to: "src/app/core/services/supabase.service.ts"
      via: "inject(SupabaseService) for getUser"
      pattern: "supabase.*getUser"
---

<objective>
Build the complete authentication flow: login, registration, email confirmation, and password reset pages with reactive forms, inline validation in German, and route guards for protecting authenticated routes.

Purpose: Users can register, see the email confirmation prompt, log in, and reset forgotten passwords. Guards protect routes so unauthenticated users are redirected to login and logged-in users skip auth pages.
Output: Four auth page components, two route guards, all with German UI text and warm green Tailwind styling.
</objective>

<execution_context>
@C:/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create route guards and auth page components</name>
  <files>
    src/app/core/guards/auth.guard.ts
    src/app/core/guards/guest.guard.ts
    src/app/features/auth/login/login.component.ts
    src/app/features/auth/login/login.component.html
    src/app/features/auth/register/register.component.ts
    src/app/features/auth/register/register.component.html
    src/app/features/auth/confirm-email/confirm-email.component.ts
    src/app/features/auth/confirm-email/confirm-email.component.html
    src/app/features/auth/reset-password/reset-password.component.ts
    src/app/features/auth/reset-password/reset-password.component.html
  </files>
  <action>
    **Route Guards (functional, angular 21 style):**

    1. Create `src/app/core/guards/auth.guard.ts`:
       - Functional `CanActivateFn` guard
       - Inject `SupabaseService` and `Router`
       - Call `supabase.getUser()` — if null, redirect to `/anmelden` (German route) with `queryParams: { returnUrl: state.url }`
       - Return `true` if user exists
       - Export as `authGuard`

    2. Create `src/app/core/guards/guest.guard.ts`:
       - Functional `CanActivateFn` guard
       - Inject `SupabaseService` and `Router`
       - Call `supabase.getUser()` — if user exists, redirect to `/gerichte` (post-login landing page per research recommendation: "Meine Gerichte")
       - Return `true` if no user (allow access to auth pages)
       - Export as `guestGuard`

    **Auth Pages — Shared Design Principles (from locked decisions):**
    - All pages are standalone components importing `ReactiveFormsModule` and `RouterLink`
    - All user-facing text in German (hardcoded, no i18n markers needed for German-only v1)
    - Warm green design: use green color palette (green-50 to green-800), rounded corners (rounded-xl, rounded-2xl), soft shadows
    - App branding: show "MahlZeitPlaner" name and a simple fork/leaf icon (use Unicode or SVG) at top of each auth page
    - Full-screen centered layout on all devices: `min-h-screen flex items-center justify-center`
    - Card container on desktop: `w-full max-w-md` with padding and shadow
    - Large touch targets on mobile: `py-3` minimum on buttons and inputs, `text-base` minimum font size
    - Error messages: red inline text directly below the failing input field (`text-red-600 text-sm mt-1`)

    3. Create **Login page** (`src/app/features/auth/login/`):
       - Reactive form with `email` (Validators.required, Validators.email) and `password` (Validators.required, Validators.minLength(8))
       - Submit button: "Anmelden" — disabled when form invalid, shows loading spinner during submission
       - On submit: call `supabaseService.signIn(email, password)`. On success, navigate to returnUrl from query params or `/gerichte`. On error, show server error message below the form (e.g., "E-Mail oder Passwort falsch")
       - Link at bottom: "Noch kein Konto? Registrieren" linking to `/registrieren`
       - Link below password: "Passwort vergessen?" linking to `/passwort-vergessen`
       - Inline validation messages (shown when field touched and invalid):
         - Email required: "E-Mail ist erforderlich"
         - Email format: "Bitte gib eine gueltige E-Mail-Adresse ein"
         - Password required: "Passwort ist erforderlich"
         - Password minlength: "Passwort muss mindestens 8 Zeichen lang sein"

    4. Create **Register page** (`src/app/features/auth/register/`):
       - Reactive form with `email` (required, email), `password` (required, minLength(8)), `displayName` (required, minLength(2))
       - Submit button: "Registrieren" — disabled when form invalid, shows loading spinner
       - On submit: call `supabaseService.signUp(email, password)` with `{ data: { display_name: displayName } }` in metadata. On success, navigate to `/email-bestaetigen`. On error, show server error below form
       - Link at bottom: "Bereits ein Konto? Anmelden" linking to `/anmelden`
       - Inline validation messages:
         - Display name required: "Name ist erforderlich"
         - Display name minlength: "Name muss mindestens 2 Zeichen lang sein"
         - Email required: "E-Mail ist erforderlich"
         - Email format: "Bitte gib eine gueltige E-Mail-Adresse ein"
         - Password required: "Passwort ist erforderlich"
         - Password minlength: "Passwort muss mindestens 8 Zeichen lang sein"

    5. Create **Confirm Email page** (`src/app/features/auth/confirm-email/`):
       - Static page (no form) showing:
         - Success icon (green checkmark or mail icon)
         - Heading: "E-Mail bestaetigen"
         - Text: "Wir haben dir eine Bestaetigungs-E-Mail geschickt. Bitte klicke auf den Link in der E-Mail, um dein Konto zu aktivieren."
         - Subtext: "Keine E-Mail erhalten? Pruefe deinen Spam-Ordner."
         - Link: "Zurueck zur Anmeldung" linking to `/anmelden`
       - Per locked decision: After registration, show this page. User cannot access app until email confirmed.

    6. Create **Reset Password page** (`src/app/features/auth/reset-password/`):
       - Per Claude's discretion: Include password reset (low effort with Supabase built-in, research confirms)
       - Reactive form with `email` (required, email)
       - Submit button: "Passwort zuruecksetzen"
       - On submit: call `supabaseService.client.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/anmelden' })`. On success, show confirmation message: "Falls ein Konto mit dieser E-Mail existiert, haben wir dir einen Link zum Zuruecksetzen geschickt."
       - Link: "Zurueck zur Anmeldung" linking to `/anmelden`
       - Inline validation: same email validators as login

    **Use angular 21 control flow syntax** (`@if`, `@for`) not `*ngIf`/`*ngFor`.
  </action>
  <verify>
    Run `ng build` — all components compile without errors.
    Check each component file exists in correct directory.
    Check each component imports ReactiveFormsModule.
    Check inline validation messages are in German.
    Check error display uses `text-red-600` class.
    Check submit buttons have disabled state when form invalid.
    Check guards use functional CanActivateFn pattern (not class-based).
  </verify>
  <done>
    Four auth pages (login, register, confirm-email, reset-password) with German text, reactive forms, inline validation below each field in red, warm green Tailwind styling, branding on each page, large touch targets, and loading states. Two functional route guards (auth and guest) protect routes appropriately.
  </done>
</task>

</tasks>

<verification>
1. All auth components compile: `ng build` succeeds
2. Login form has email and password fields with German inline validation
3. Register form has displayName, email, and password fields with German inline validation
4. Confirm-email page shows static confirmation message in German
5. Reset-password page has email field with Supabase resetPasswordForEmail integration
6. Auth guard redirects to /anmelden when no user
7. Guest guard redirects to /gerichte when user exists
8. All pages use warm green Tailwind design with rounded corners and app branding
</verification>

<success_criteria>
- Login page accepts email/password, calls Supabase signIn, shows inline German errors
- Register page accepts name/email/password, calls Supabase signUp, redirects to confirm page
- Confirm-email page displays "check your email" message in German
- Reset-password page sends password reset email via Supabase
- Auth guard blocks unauthenticated access to protected routes
- Guest guard prevents logged-in users from seeing auth pages
- All error messages appear inline below fields in red text
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
