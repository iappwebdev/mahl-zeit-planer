---
phase: 04-realtime-collaboration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/features/settings/settings.component.ts
  - src/app/features/settings/settings.component.html
  - src/app/features/settings/components/household-panel/household-panel.component.ts
  - src/app/features/settings/components/household-panel/household-panel.component.html
  - src/app/features/auth/accept-invite/accept-invite.component.ts
  - src/app/features/auth/accept-invite/accept-invite.component.html
  - src/app/app.routes.ts
  - src/app/shared/components/navbar/navbar.component.html
  - src/app/shared/components/navbar/navbar.component.ts
  - src/app/shared/components/layout/layout.component.ts
  - supabase/functions/invite-user/index.ts
autonomous: true
requirements: [AUTH-04, AUTH-05]
user_setup:
  - service: supabase-edge-functions
    why: "Email invite requires service-role key in Edge Function (NEVER in frontend)"
    env_vars:
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role key (secret)"
    dashboard_config:
      - task: "Deploy Edge Function after creation"
        location: "Run: supabase functions deploy invite-user"

must_haves:
  truths:
    - "User can create a household from the Einstellungen page"
    - "User can see household members and their roles"
    - "User can generate a shareable invite link with 7-day expiry"
    - "User can send an email invite via Edge Function"
    - "Invited user (new or existing) can accept an invite and auto-join the household"
    - "Owner can remove members; any member can leave"
    - "Owner can delete the household"
    - "Einstellungen link appears in navigation (desktop and mobile)"
  artifacts:
    - path: "src/app/features/settings/settings.component.ts"
      provides: "Settings page hosting the Haushalt panel"
    - path: "src/app/features/settings/components/household-panel/household-panel.component.ts"
      provides: "Household management UI: create, view members, invite, leave, delete"
    - path: "src/app/features/auth/accept-invite/accept-invite.component.ts"
      provides: "Invite acceptance page that reads token from URL and joins household"
    - path: "supabase/functions/invite-user/index.ts"
      provides: "Edge Function calling auth.admin.inviteUserByEmail with service-role key"
    - path: "src/app/app.routes.ts"
      provides: "Routes for /einstellungen and /einladen (invite acceptance)"
  key_links:
    - from: "src/app/features/settings/components/household-panel/household-panel.component.ts"
      to: "src/app/core/services/household.service.ts"
      via: "inject(HouseholdService)"
      pattern: "inject\\(HouseholdService\\)"
    - from: "src/app/features/auth/accept-invite/accept-invite.component.ts"
      to: "src/app/core/services/household.service.ts"
      via: "HouseholdService.acceptInvite(token)"
      pattern: "acceptInvite"
    - from: "supabase/functions/invite-user/index.ts"
      to: "Supabase Auth Admin API"
      via: "supabase.auth.admin.inviteUserByEmail()"
      pattern: "inviteUserByEmail"
    - from: "src/app/app.routes.ts"
      to: "src/app/features/settings/settings.component.ts"
      via: "route /einstellungen"
      pattern: "einstellungen"
---

<objective>
Build the household management UI in the settings page and the complete invite system (shareable links + email invites via Edge Function).

Purpose: Users need a way to create households, invite family members, and manage membership. This plan delivers the full Haushalt section in Einstellungen and the invite acceptance flow, enabling family collaboration.

Output:
- Settings page with Haushalt section at `/einstellungen`
- Household panel component for create/manage/invite/leave/delete
- Accept-invite page at `/einladen` for processing invite tokens
- Edge Function `invite-user` for secure email invitations
- Updated navigation with Einstellungen link
- Updated routes
</objective>

<execution_context>
@C:/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-realtime-collaboration/04-CONTEXT.md
@.planning/phases/04-realtime-collaboration/04-RESEARCH.md
@.planning/phases/04-realtime-collaboration/04-01-SUMMARY.md
@src/app/app.routes.ts
@src/app/shared/components/navbar/navbar.component.ts
@src/app/shared/components/navbar/navbar.component.html
@src/app/core/services/household.service.ts
@src/app/features/settings/models/household.model.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings page with household panel, update navigation and routes</name>
  <files>
    src/app/features/settings/settings.component.ts
    src/app/features/settings/settings.component.html
    src/app/features/settings/components/household-panel/household-panel.component.ts
    src/app/features/settings/components/household-panel/household-panel.component.html
    src/app/app.routes.ts
    src/app/shared/components/navbar/navbar.component.html
    src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
**A. Create SettingsComponent** (`src/app/features/settings/`):

Simple page container. German heading "Einstellungen". Imports and renders HouseholdPanelComponent. Follow same styling patterns as DishesComponent (max-w-4xl, p-4, green theme).

Template structure:
```html
<div class="p-4 max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Einstellungen</h1>
  <app-household-panel />
</div>
```

**B. Create HouseholdPanelComponent** (`src/app/features/settings/components/household-panel/`):

Standalone component. Inject HouseholdService, MatSnackBar, inject(SupabaseService) for current user. Uses Angular 17+ control flow (@if/@for).

**State signals:**
- `household` = computed from `householdService.currentHousehold()`
- `members` = signal<HouseholdMember[]>([])
- `invites` = signal<HouseholdInvite[]>([])
- `isLoading` = signal(true)
- `newHouseholdName` = signal('')
- `inviteEmail` = signal('')
- `inviteLink` = signal<string | null>(null)
- `isSendingInvite` = signal(false)

**On init:**
- Call `householdService.loadCurrentHousehold()`
- If household exists, load members and invites
- Set isLoading to false

**Template — Two states:**

**State 1: No household (solo mode)**
Card with heading "Haushalt erstellen". Text explaining: "Erstelle einen Haushalt, um Gerichte und Wochenpläne mit deiner Familie zu teilen."
- Text input for household name (placeholder: "z.B. Familie Mueller")
- "Haushalt erstellen" button (green, disabled if name empty)
- On submit: call `householdService.createHousehold(name)`, show snackbar "Haushalt erstellt!", reload.

**State 2: Has household**
Card with heading showing household name (e.g. "Haushalt: Familie Mueller").

**Members section:**
- Heading "Mitglieder" with member count badge
- List each member: display_name (or "Unbekannt"), role badge ("Besitzer" green pill / "Mitglied" gray pill)
- If current user is owner: show remove button (red X) next to each non-owner member. On click: confirm with `window.confirm('Mitglied entfernen?')`, call `removeMember(memberId)`, reload members, snackbar "Mitglied entfernt".

**Invite section:**
- Heading "Einladen"
- "Link erstellen" button — calls `householdService.createInviteLink()`, constructs URL: `${window.location.origin}/einladen?token=${token}`, copies to clipboard via `navigator.clipboard.writeText()`, shows snackbar "Einladungslink kopiert!"
- Email invite: text input for email, "Per E-Mail einladen" button. On submit: POST to Supabase Edge Function `/functions/v1/invite-user` with `{ email, household_id, token }` (create invite first to get token). Show snackbar "Einladung gesendet an {email}".
- Active invites list: show each pending invite (not expired, not used) with email/link indicator and expiry date. No delete button needed for v1.

**Actions section:**
- "Haushalt verlassen" button (amber, shown to non-owner members). Confirm dialog. Calls `leaveHousehold()`. Snackbar "Du hast den Haushalt verlassen".
- "Haushalt loeschen" button (red, shown only to owner). Confirm dialog with strong warning text. Calls `deleteHousehold()`. Snackbar "Haushalt geloescht".

**C. Update app.routes.ts:**

Add SettingsComponent as a child of the authenticated layout:
```typescript
{ path: 'einstellungen', component: SettingsComponent },
```

Add accept-invite route (outside auth guard — needs to work for users who may need to register first):
```typescript
{
  path: 'einladen',
  loadComponent: () => import('./features/auth/accept-invite/accept-invite.component').then(m => m.AcceptInviteComponent)
}
```

Import SettingsComponent at top of file.

**D. Update NavbarComponent:**

Add "Einstellungen" link to navigation. In desktop nav: add between "Wochenplan" and "Abmelden" button:
```html
<a routerLink="/einstellungen" routerLinkActive="bg-green-600"
   class="px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
  Einstellungen
</a>
```

In mobile nav: add a new tab between Wochenplan and Abmelden with gear icon (use the unicode gear emoji or inline SVG gear icon). Label: "Mehr" or "Einstellungen" (keep text short for mobile).

Use a gear emoji: ⚙️ with label "Mehr".
  </action>
  <verify>
    - `src/app/features/settings/settings.component.ts` exists
    - `src/app/features/settings/settings.component.html` contains "Einstellungen"
    - `src/app/features/settings/components/household-panel/household-panel.component.ts` exists and injects HouseholdService
    - Template contains "Haushalt erstellen" and "Mitglieder" and "Einladen"
    - `src/app/app.routes.ts` contains `path: 'einstellungen'`
    - `src/app/app.routes.ts` contains `path: 'einladen'`
    - Navbar HTML contains "Einstellungen" or "Mehr" link to `/einstellungen`
    - `ng build` compiles without errors
  </verify>
  <done>
    Settings page with Haushalt panel renders at /einstellungen. Users can create a household, see members, generate invite links, send email invites, leave, or delete. Navigation includes Einstellungen link on desktop and mobile. Routes configured for settings and invite acceptance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invite acceptance page and Edge Function for email invites</name>
  <files>
    src/app/features/auth/accept-invite/accept-invite.component.ts
    src/app/features/auth/accept-invite/accept-invite.component.html
    src/app/shared/components/layout/layout.component.ts
    supabase/functions/invite-user/index.ts
  </files>
  <action>
**A. Create AcceptInviteComponent** (`src/app/features/auth/accept-invite/`):

Standalone component. Handles the `/einladen?token=XYZ` route.

**Flow:**
1. On init, read `token` from query params (`inject(ActivatedRoute).queryParamMap`).
2. If no token: show error "Kein Einladungstoken gefunden."
3. Check if user is authenticated (via SupabaseService.getSession()).
4. **If authenticated:**
   - Call `householdService.acceptInvite(token)`.
   - On success: show "Du bist dem Haushalt beigetreten!" message. Show "Zu Einstellungen" button linking to `/einstellungen`.
   - On error (expired, already used, invalid): show specific German error message.
5. **If NOT authenticated:**
   - Store token in `sessionStorage.setItem('invite_token', token)`.
   - Show message: "Bitte melde dich an oder registriere dich, um die Einladung anzunehmen."
   - Show two buttons: "Anmelden" (link to `/anmelden`) and "Registrieren" (link to `/registrieren`).
   - After the user registers/logs in and lands on a protected page, check for `sessionStorage.getItem('invite_token')` in the app initializer or LayoutComponent — if found, call `householdService.acceptInvite(token)`, remove from sessionStorage, show snackbar "Du bist dem Haushalt beigetreten!".

**For the post-auth invite acceptance**, add a check in `LayoutComponent` (or create a small service called in layout's ngOnInit):
- In `src/app/shared/components/layout/layout.component.ts`, add logic on init:
  ```typescript
  const inviteToken = sessionStorage.getItem('invite_token');
  if (inviteToken) {
    sessionStorage.removeItem('invite_token');
    try {
      await this.householdService.acceptInvite(inviteToken);
      this.snackBar.open('Du bist dem Haushalt beigetreten!', '', { duration: 4000 });
    } catch (e) {
      this.snackBar.open('Einladung konnte nicht angenommen werden.', '', { duration: 4000 });
    }
  }
  ```
  Add `inject(HouseholdService)` and `inject(MatSnackBar)` to LayoutComponent. Add file to files list: `src/app/shared/components/layout/layout.component.ts`.

**Template states:**
- Loading state: "Einladung wird verarbeitet..." with spinner
- Success state: green card with "Willkommen im Haushalt!" heading, household name, "Zu Einstellungen" button
- Error state: red card with error message
- Not authenticated state: card with login/register prompt

**Styling:** Follow same green theme as rest of app. Centered card layout like auth pages.

**B. Create Edge Function** (`supabase/functions/invite-user/index.ts`):

Deno-based Supabase Edge Function. Receives POST with JSON body `{ email, household_id, token }`.

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  // CORS headers
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  }

  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { email, household_id, token } = await req.json()

    // Validate input
    if (!email || !household_id || !token) {
      return new Response(
        JSON.stringify({ error: 'Missing required fields' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Create admin client with service role key
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '',
      { auth: { autoRefreshToken: false, persistSession: false } }
    )

    // Verify the invite token exists and is valid
    const { data: invite, error: inviteError } = await supabaseAdmin
      .from('household_invites')
      .select('*')
      .eq('token', token)
      .eq('household_id', household_id)
      .is('used_at', null)
      .gt('expires_at', new Date().toISOString())
      .single()

    if (inviteError || !invite) {
      return new Response(
        JSON.stringify({ error: 'Invalid or expired invite' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // Send invite email via Supabase Auth Admin
    const redirectUrl = `${Deno.env.get('SITE_URL') ?? 'http://localhost:4200'}/einladen?token=${token}`

    const { error: authError } = await supabaseAdmin.auth.admin.inviteUserByEmail(email, {
      redirectTo: redirectUrl,
    })

    if (authError) {
      // If user already exists, the invite still sends a magic link
      // Only throw on actual errors
      if (!authError.message.includes('already registered')) {
        return new Response(
          JSON.stringify({ error: authError.message }),
          { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        )
      }
    }

    // Update invite with the email
    await supabaseAdmin
      .from('household_invites')
      .update({ invited_email: email })
      .eq('id', invite.id)

    return new Response(
      JSON.stringify({ success: true }),
      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  } catch (err) {
    return new Response(
      JSON.stringify({ error: err.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})
```

**CRITICAL:** The service-role key is accessed via `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')` and is NEVER exposed to the frontend. The Edge Function runs server-side.
  </action>
  <verify>
    - `src/app/features/auth/accept-invite/accept-invite.component.ts` exists
    - Component reads `token` from query params
    - Component handles authenticated and unauthenticated states
    - Component calls `householdService.acceptInvite(token)` on success
    - `sessionStorage` used for persisting invite token through registration flow
    - `supabase/functions/invite-user/index.ts` exists
    - Edge Function imports createClient from supabase-js
    - Edge Function uses `SUPABASE_SERVICE_ROLE_KEY` from Deno.env (not hardcoded)
    - Edge Function calls `auth.admin.inviteUserByEmail`
    - Edge Function validates invite token before sending email
    - `ng build` compiles without errors
  </verify>
  <done>
    Accept-invite page handles both authenticated (direct join) and unauthenticated (store token, redirect to login/register, auto-join after auth) flows. Edge Function securely sends email invites using service-role key server-side. Invite token persists through registration flow via sessionStorage.
  </done>
</task>

</tasks>

<verification>
- Settings page loads at /einstellungen with Haushalt section
- Household creation flow: enter name -> create -> members list appears with owner
- Invite link generation: click button -> link copied to clipboard
- Email invite: enter email -> POST to Edge Function -> invite sent
- Accept invite: visit /einladen?token=XYZ -> join household (authenticated) or redirect to login (unauthenticated)
- Post-auth join: register with invite token in sessionStorage -> auto-join on first authenticated page load
- Navigation shows Einstellungen link on both desktop and mobile
- Owner can remove members and delete household
- Member can leave household
- `ng build` passes
</verification>

<success_criteria>
- Household management fully functional from /einstellungen
- Invite system works for both shareable links and email invites
- Edge Function deployed and callable
- Accept-invite handles both auth states
- Navigation updated on all screen sizes
</success_criteria>

<output>
After completion, create `.planning/phases/04-realtime-collaboration/04-02-SUMMARY.md`
</output>
