---
phase: 04-realtime-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_households.sql
  - src/app/features/settings/models/household.model.ts
  - src/app/core/services/household.service.ts
  - src/app/features/dishes/services/dish.service.ts
  - src/app/features/meal-plan/services/meal-plan.service.ts
autonomous: true
requirements: [AUTH-04, AUTH-06]

must_haves:
  truths:
    - "Households, household_members, and household_invites tables exist with RLS policies enforcing ownership and membership"
    - "Dishes and weekly_plans tables have nullable household_id FK column"
    - "RLS policies on dishes and weekly_plans support both solo (user_id) and household (household_id membership) access"
    - "HouseholdService can create a household, add/remove members, and migrate user data to household"
    - "DishService and MealPlanService query by household_id when user belongs to a household, or by user_id when solo"
  artifacts:
    - path: "supabase/migrations/004_households.sql"
      provides: "households, household_members, household_invites tables with RLS; ALTER dishes/weekly_plans with household_id; updated RLS policies for dual-mode; activity_log table; Realtime publication"
      contains: "CREATE TABLE public.households"
    - path: "src/app/features/settings/models/household.model.ts"
      provides: "Household, HouseholdMember, HouseholdInvite TypeScript interfaces"
      exports: ["Household", "HouseholdMember", "HouseholdInvite", "HouseholdRole"]
    - path: "src/app/core/services/household.service.ts"
      provides: "HouseholdService with create, invite, join, leave, remove member, get members, get current household"
      exports: ["HouseholdService"]
    - path: "src/app/features/dishes/services/dish.service.ts"
      provides: "Updated DishService with household-aware queries"
    - path: "src/app/features/meal-plan/services/meal-plan.service.ts"
      provides: "Updated MealPlanService with household-aware queries"
  key_links:
    - from: "src/app/core/services/household.service.ts"
      to: "src/app/core/services/supabase.service.ts"
      via: "inject(SupabaseService)"
      pattern: "inject\\(SupabaseService\\)"
    - from: "src/app/features/dishes/services/dish.service.ts"
      to: "src/app/core/services/household.service.ts"
      via: "inject(HouseholdService) for household_id resolution"
      pattern: "inject\\(HouseholdService\\)"
    - from: "src/app/features/meal-plan/services/meal-plan.service.ts"
      to: "src/app/core/services/household.service.ts"
      via: "inject(HouseholdService) for household_id resolution"
      pattern: "inject\\(HouseholdService\\)"
---

<objective>
Create the database foundation for household collaboration and update all existing services to support dual-mode access (solo user vs. household member).

Purpose: This is the foundational data layer for Phase 4. Without household tables and dual-mode RLS policies, no collaboration features can function. Updating DishService and MealPlanService now ensures all downstream UI work (Plans 02 and 03) can consume household-aware data immediately.

Output:
- `004_households.sql` migration with 4 new tables (households, household_members, household_invites, activity_log), updated RLS on dishes/weekly_plans, Realtime publication
- TypeScript models for household domain
- HouseholdService with full CRUD for household lifecycle
- Updated DishService and MealPlanService with household-aware queries
</objective>

<execution_context>
@C:/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-realtime-collaboration/04-CONTEXT.md
@.planning/phases/04-realtime-collaboration/04-RESEARCH.md
@.planning/phases/02-dish-management/02-01-SUMMARY.md
@.planning/phases/03-meal-planning/03-01-SUMMARY.md
@supabase/migrations/002_dishes.sql
@supabase/migrations/003_meal_plans.sql
@src/app/features/dishes/services/dish.service.ts
@src/app/features/meal-plan/services/meal-plan.service.ts
@src/app/core/services/supabase.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create household database migration with dual-mode RLS policies</name>
  <files>supabase/migrations/004_households.sql</files>
  <action>
Create migration `004_households.sql` with the following schema:

**1. households table:**
- `id UUID DEFAULT gen_random_uuid() PRIMARY KEY`
- `name TEXT NOT NULL` (household display name, e.g. "Familie Mueller")
- `owner_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE`
- `created_at TIMESTAMPTZ DEFAULT NOW()`
- `updated_at TIMESTAMPTZ DEFAULT NOW()`

**2. household_members table:**
- `id UUID DEFAULT gen_random_uuid() PRIMARY KEY`
- `household_id UUID NOT NULL REFERENCES public.households(id) ON DELETE CASCADE`
- `user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE`
- `role TEXT NOT NULL CHECK (role IN ('owner', 'member'))` — TEXT with CHECK (same pattern as dishes.category)
- `joined_at TIMESTAMPTZ DEFAULT NOW()`
- `UNIQUE (household_id, user_id)` — one membership per user per household
- Add index: `idx_household_members_user ON household_members(user_id)` — for membership lookups
- Add index: `idx_household_members_household ON household_members(household_id)` — for listing members

**3. household_invites table:**
- `id UUID DEFAULT gen_random_uuid() PRIMARY KEY`
- `household_id UUID NOT NULL REFERENCES public.households(id) ON DELETE CASCADE`
- `token TEXT NOT NULL UNIQUE DEFAULT encode(gen_random_bytes(32), 'hex')` — 64-char hex token
- `invited_email TEXT` — NULL for shareable link, set for email invite
- `created_by UUID NOT NULL REFERENCES auth.users(id)`
- `expires_at TIMESTAMPTZ NOT NULL DEFAULT NOW() + INTERVAL '7 days'` — 7-day expiry per CONTEXT.md
- `used_at TIMESTAMPTZ` — NULL until accepted
- `created_at TIMESTAMPTZ DEFAULT NOW()`
- Add index: `idx_household_invites_token ON household_invites(token)` — token lookup

**4. activity_log table (for activity feed):**
- `id UUID DEFAULT gen_random_uuid() PRIMARY KEY`
- `household_id UUID NOT NULL REFERENCES public.households(id) ON DELETE CASCADE`
- `user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE`
- `action TEXT NOT NULL` — e.g. 'dish_added', 'dish_deleted', 'plan_generated', 'assignment_changed'
- `entity_type TEXT NOT NULL` — e.g. 'dish', 'meal_assignment', 'weekly_plan'
- `entity_name TEXT` — human-readable name, e.g. dish name or "Montag"
- `created_at TIMESTAMPTZ DEFAULT NOW()`
- Add index: `idx_activity_log_household ON activity_log(household_id, created_at DESC)` — feed queries

**5. ALTER existing tables — add nullable household_id:**
```sql
ALTER TABLE public.dishes
  ADD COLUMN household_id UUID REFERENCES public.households(id) ON DELETE SET NULL;
CREATE INDEX idx_dishes_household ON public.dishes(household_id);

ALTER TABLE public.weekly_plans
  ADD COLUMN household_id UUID REFERENCES public.households(id) ON DELETE SET NULL;
CREATE INDEX idx_weekly_plans_household ON public.weekly_plans(household_id);
```

**6. weekly_plans partial unique index for household mode:**
```sql
CREATE UNIQUE INDEX idx_weekly_plans_household_week
ON public.weekly_plans (household_id, week_start)
WHERE household_id IS NOT NULL;
```
This handles the fact that in household mode, multiple users share ONE plan per week. The existing `UNIQUE (user_id, week_start)` constraint remains for solo users.

**7. Enable RLS on new tables:**
```sql
ALTER TABLE public.households ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.household_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.household_invites ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.activity_log ENABLE ROW LEVEL SECURITY;
```

**8. RLS Policies — households:**
- SELECT: authenticated users who are members (`EXISTS (SELECT 1 FROM household_members WHERE household_id = households.id AND user_id = (SELECT auth.uid()))`)
- INSERT: any authenticated user can create a household (`(SELECT auth.uid()) = owner_id`)
- UPDATE: only owner (`(SELECT auth.uid()) = owner_id`)
- DELETE: only owner (`(SELECT auth.uid()) = owner_id`)

**9. RLS Policies — household_members:**
- SELECT: members can see other members of same household (`EXISTS (SELECT 1 FROM household_members hm WHERE hm.household_id = household_members.household_id AND hm.user_id = (SELECT auth.uid()))`)
- INSERT: members can add new members (for invite acceptance) (`EXISTS (SELECT 1 FROM household_members hm WHERE hm.household_id = household_members.household_id AND hm.user_id = (SELECT auth.uid()))`)
  - Also allow self-insert for first member (owner) after creating household: `OR (SELECT auth.uid()) = user_id`
- DELETE: only owner can remove members (`EXISTS (SELECT 1 FROM household_members hm WHERE hm.household_id = household_members.household_id AND hm.user_id = (SELECT auth.uid()) AND hm.role = 'owner')`) OR member can remove themselves (`(SELECT auth.uid()) = user_id`)

**10. RLS Policies — household_invites:**
- SELECT: household members can view invites for their household
- INSERT: household members can create invites (any member can invite, per CONTEXT.md)
- UPDATE: household members can mark invites as used (for acceptance flow)
- DELETE: household members can delete invites

**11. RLS Policies — activity_log:**
- SELECT: household members can view activity for their household
- INSERT: household members can insert activity entries

**12. Update RLS Policies on dishes — DUAL MODE:**
Drop existing 4 policies on dishes. Create new ones supporting both solo AND household:

```sql
-- SELECT: own dishes (solo) OR household member's dishes
CREATE POLICY "Users can view own or household dishes"
ON public.dishes FOR SELECT TO authenticated
USING (
  (SELECT auth.uid()) = user_id
  OR
  (household_id IS NOT NULL AND EXISTS (
    SELECT 1 FROM public.household_members
    WHERE household_id = dishes.household_id
    AND user_id = (SELECT auth.uid())
  ))
);
```

For INSERT: allow if user_id matches AND (household_id IS NULL OR user is member of household_id).
For UPDATE: same dual check as SELECT.
For DELETE: same dual check as SELECT.

**13. Update RLS Policies on weekly_plans — DUAL MODE:**
Drop existing 4 policies. Create new dual-mode policies following same pattern as dishes (solo OR household membership).

**14. Update RLS Policies on meal_assignments — DUAL MODE:**
Drop existing 4 policies. Create new policies checking weekly_plan ownership via dual-mode (weekly_plans.user_id match OR weekly_plans.household_id membership).

**15. Enable Realtime publication:**
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE public.dishes;
ALTER PUBLICATION supabase_realtime ADD TABLE public.weekly_plans;
ALTER PUBLICATION supabase_realtime ADD TABLE public.meal_assignments;
ALTER PUBLICATION supabase_realtime ADD TABLE public.household_members;
ALTER PUBLICATION supabase_realtime ADD TABLE public.activity_log;
```

**16. Triggers:**
- Reuse `update_updated_at()` for households table
- Create activity_log triggers on dishes and meal_assignments for automatic logging (INSERT/UPDATE/DELETE on dishes writes to activity_log; INSERT/UPDATE/DELETE on meal_assignments writes to activity_log). These triggers should be `SECURITY DEFINER` functions that look up household_id and user display name from profiles. Only fire when household_id IS NOT NULL on the affected row.

**CRITICAL:** Use `(SELECT auth.uid())` wrapper in ALL RLS policies (established project pattern, 94-99% performance improvement).
  </action>
  <verify>
    - File exists at `supabase/migrations/004_households.sql`
    - Contains `CREATE TABLE public.households`
    - Contains `CREATE TABLE public.household_members`
    - Contains `CREATE TABLE public.household_invites`
    - Contains `CREATE TABLE public.activity_log`
    - Contains `ALTER TABLE public.dishes ADD COLUMN household_id`
    - Contains `ALTER TABLE public.weekly_plans ADD COLUMN household_id`
    - Contains `DROP POLICY` for all old dishes/weekly_plans/meal_assignments policies
    - Contains new dual-mode policies with household membership check
    - Count of `(SELECT auth.uid())` occurrences >= 20
    - Contains `ALTER PUBLICATION supabase_realtime`
    - Contains `CREATE UNIQUE INDEX idx_weekly_plans_household_week`
  </verify>
  <done>
    Migration file creates all household infrastructure tables with RLS, updates existing tables with household_id FK, replaces all RLS policies on dishes/weekly_plans/meal_assignments with dual-mode policies, enables Realtime publication, and creates activity logging triggers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create household models, HouseholdService, and update DishService/MealPlanService for household-aware queries</name>
  <files>
    src/app/features/settings/models/household.model.ts
    src/app/core/services/household.service.ts
    src/app/features/dishes/services/dish.service.ts
    src/app/features/meal-plan/services/meal-plan.service.ts
  </files>
  <action>
**A. Create `src/app/features/settings/models/household.model.ts`:**

```typescript
export type HouseholdRole = 'owner' | 'member';

export interface Household {
  id: string;
  name: string;
  owner_id: string;
  created_at: string;
  updated_at: string;
}

export interface HouseholdMember {
  id: string;
  household_id: string;
  user_id: string;
  role: HouseholdRole;
  joined_at: string;
  // Joined from profiles table
  display_name?: string;
}

export interface HouseholdInvite {
  id: string;
  household_id: string;
  token: string;
  invited_email: string | null;
  created_by: string;
  expires_at: string;
  used_at: string | null;
  created_at: string;
}

export interface ActivityLogEntry {
  id: string;
  household_id: string;
  user_id: string;
  action: string;
  entity_type: string;
  entity_name: string | null;
  created_at: string;
  // Joined from profiles
  display_name?: string;
}
```

**B. Create `src/app/core/services/household.service.ts`:**

Injectable service (providedIn: 'root') with inject(SupabaseService). Follows DishService error pattern (throw on error, no try/catch).

**Signals:**
- `currentHousehold = signal<Household | null>(null)` — the user's household (null = solo)
- `householdId = computed(() => this.currentHousehold()?.id ?? null)` — convenience computed

**Methods:**

1. `async loadCurrentHousehold(): Promise<void>` — query `household_members` for current user's membership, then load the household. Set `currentHousehold` signal. Call this on app init (e.g., in constructor or from app initializer). If no membership found, set signal to null (solo mode).

2. `async createHousehold(name: string): Promise<Household>` — insert household with owner_id = current user, insert household_members row with role='owner', then migrate existing user's dishes (update household_id where user_id matches and household_id IS NULL), migrate existing weekly_plans same way. Return created household. Update `currentHousehold` signal.

3. `async getMembers(): Promise<HouseholdMember[]>` — query household_members for current household with joined profiles data (display_name). Return empty array if no household.

4. `async removeMember(memberId: string): Promise<void>` — delete from household_members. Only owner should call this (UI enforces).

5. `async leaveHousehold(): Promise<void>` — delete own membership from household_members. Set `currentHousehold` signal to null.

6. `async deleteHousehold(): Promise<void>` — delete the household (CASCADE deletes members). Set `currentHousehold` signal to null. Only owner.

7. `async createInviteLink(): Promise<string>` — insert into household_invites with no email, return the token. Caller builds the URL.

8. `async getInvites(): Promise<HouseholdInvite[]>` — query household_invites for current household, filter out expired/used.

9. `async acceptInvite(token: string): Promise<void>` — query invite by token, check not expired/used, insert into household_members with role='member', mark invite used_at = NOW(), migrate user's existing dishes/plans to the household (same as createHousehold migration step). Update `currentHousehold` signal.

10. `async getActivityLog(limit: number = 20): Promise<ActivityLogEntry[]>` — query activity_log for current household ordered by created_at DESC, limit. Join profiles for display_name.

11. `isOwner(): boolean` — computed check: currentHousehold()?.owner_id matches current user id.

**C. Update `src/app/features/dishes/services/dish.service.ts`:**

Add `private household = inject(HouseholdService)`.

Update `getAll()`:
- If `this.household.householdId()` is not null, query dishes where `household_id = householdId` (household mode — RLS ensures only household members see these).
- If null (solo), keep existing query (RLS filters by user_id).
- Keep ordering: `is_favorite DESC, name ASC`.

Update `create()`:
- If household mode, set `household_id` in the insert alongside `user_id`.
- Solo mode unchanged.

No changes needed to `update()`, `delete()`, `toggleFavorite()` — RLS handles access, and they operate by `id` which doesn't change.

**D. Update `src/app/features/meal-plan/services/meal-plan.service.ts`:**

Add `private household = inject(HouseholdService)`.

Update `getOrCreateWeeklyPlan(weekStart)`:
- If household mode: query by `household_id` + `week_start` (not user_id). On create, set both `user_id` (creator) and `household_id`.
- Solo mode: keep existing user_id-based query.

Update `getAssignmentsForWeek(weekStart)`:
- If household mode: find plan by `household_id` + `week_start`.
- Solo mode: unchanged.

Update `getRecentDishIds(currentWeekStart, weeksBack)`:
- If household mode: filter weekly_plans by `household_id` instead of `user_id`.
- Solo mode: unchanged.

No changes needed to `assignDish()`, `removeDish()`, `clearWeekAssignments()` — they work on plan/assignment IDs.

No changes to `getCategoryPreferences()` or `saveCategoryPreferences()` — per research, keep user-scoped (defer "whose preferences" question).
  </action>
  <verify>
    - `src/app/features/settings/models/household.model.ts` exists and exports Household, HouseholdMember, HouseholdInvite, ActivityLogEntry, HouseholdRole
    - `src/app/core/services/household.service.ts` exists and exports HouseholdService
    - HouseholdService has `currentHousehold` signal and `householdId` computed
    - HouseholdService has methods: loadCurrentHousehold, createHousehold, getMembers, removeMember, leaveHousehold, deleteHousehold, createInviteLink, getInvites, acceptInvite, getActivityLog
    - DishService imports and injects HouseholdService
    - DishService `getAll()` checks `this.household.householdId()` for household-aware query
    - DishService `create()` sets `household_id` when in household mode
    - MealPlanService imports and injects HouseholdService
    - MealPlanService `getOrCreateWeeklyPlan()` uses household_id when in household mode
    - `ng build` compiles without TypeScript errors
  </verify>
  <done>
    Household model types exported. HouseholdService manages full lifecycle (create, join, leave, invite, activity log). DishService and MealPlanService query by household_id when user belongs to a household, falling back to user_id for solo users. Angular build passes.
  </done>
</task>

</tasks>

<verification>
- Migration file is syntactically valid SQL (no unterminated statements)
- All new tables have RLS enabled before any policies
- All RLS policies use `(SELECT auth.uid())` wrapper
- Dual-mode policies on dishes/weekly_plans/meal_assignments correctly OR solo + household conditions
- TypeScript models match database schema exactly
- HouseholdService signals update correctly on create/join/leave
- DishService and MealPlanService remain backwards-compatible for solo users
- `ng build` succeeds with zero errors
</verification>

<success_criteria>
- 004_households.sql creates 4 new tables, alters 2 existing tables, replaces all RLS policies for dual-mode, and enables Realtime
- HouseholdService provides complete household lifecycle management with reactive signals
- DishService and MealPlanService transparently support both solo and household modes
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-realtime-collaboration/04-01-SUMMARY.md`
</output>
