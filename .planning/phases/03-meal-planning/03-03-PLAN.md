---
phase: 03-meal-planning
plan: 03
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - src/app/features/meal-plan/services/meal-plan-generator.service.ts
  - src/app/features/meal-plan/components/category-config/category-config.component.ts
  - src/app/features/meal-plan/components/category-config/category-config.component.html
  - src/app/features/meal-plan/meal-plan.component.ts
  - src/app/features/meal-plan/meal-plan.component.html
autonomous: true
requirements: [PLAN-02, PLAN-03, PLAN-04, PLAN-05, PLAN-07]
must_haves:
  truths:
    - "User can click a button to auto-generate a complete weekly meal plan"
    - "Generated plan respects user-configured category balance (e.g., 2x Fleisch, 2x Vegetarisch, 1x Fisch)"
    - "Generated plan prefers favorite dishes over non-favorites"
    - "Generated plan avoids dishes used in the previous 2 weeks"
    - "User can configure category balance via number inputs (how many of each category per week)"
    - "Leftover days (when counts do not sum to 7) are filled from any category"
    - "Small library fallback: allows repeats but shows warning 'Nicht genugend Gerichte fur volle Abwechslung'"
    - "Regenerating a week with existing assignments shows confirmation dialog"
    - "User can regenerate the entire week with one click"
    - "Generate button is disabled while generation is in progress (loading state)"
  artifacts:
    - path: "src/app/features/meal-plan/services/meal-plan-generator.service.ts"
      provides: "Greedy randomized generation algorithm with category balance, favorite preference, repeat avoidance"
      exports: ["MealPlanGeneratorService"]
    - path: "src/app/features/meal-plan/components/category-config/category-config.component.ts"
      provides: "Category balance configuration UI with number inputs per category"
      min_lines: 40
    - path: "src/app/features/meal-plan/components/category-config/category-config.component.html"
      provides: "Category config template with inputs and available dish counts"
      min_lines: 20
  key_links:
    - from: "src/app/features/meal-plan/services/meal-plan-generator.service.ts"
      to: "src/app/features/meal-plan/services/meal-plan.service.ts"
      via: "inject(MealPlanService) for recent dishes and preferences"
      pattern: "inject\\(MealPlanService\\)"
    - from: "src/app/features/meal-plan/services/meal-plan-generator.service.ts"
      to: "src/app/features/dishes/services/dish.service.ts"
      via: "inject(DishService) for loading dish pool"
      pattern: "inject\\(DishService\\)"
    - from: "src/app/features/meal-plan/meal-plan.component.ts"
      to: "src/app/features/meal-plan/services/meal-plan-generator.service.ts"
      via: "inject(MealPlanGeneratorService) for generate button"
      pattern: "inject\\(MealPlanGeneratorService\\)"
    - from: "src/app/features/meal-plan/meal-plan.component.ts"
      to: "src/app/features/meal-plan/components/category-config/category-config.component.ts"
      via: "template reference or dialog"
      pattern: "CategoryConfigComponent"
---

<objective>
Implement the meal plan generation algorithm with category balance configuration, favorite preference, repeat avoidance, and integrate it into the weekly calendar UI.

Purpose: Deliver the core value proposition of the app -- one-click generation of balanced weekly dinner plans. This transforms the manual calendar from Plan 02 into an intelligent automated planner.

Output: Working generation algorithm, category balance configuration UI, and integrated generate/regenerate buttons in the calendar.
</objective>

<execution_context>
@C:/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-CONTEXT.md
@.planning/phases/03-meal-planning/03-RESEARCH.md
@.planning/phases/03-meal-planning/03-01-SUMMARY.md
@.planning/phases/03-meal-planning/03-02-SUMMARY.md
@src/app/features/meal-plan/models/meal-plan.model.ts
@src/app/features/meal-plan/services/meal-plan.service.ts
@src/app/features/meal-plan/meal-plan.component.ts
@src/app/features/meal-plan/meal-plan.component.html
@src/app/features/dishes/models/dish.model.ts
@src/app/features/dishes/services/dish.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement generation algorithm service and category config component</name>
  <files>
    src/app/features/meal-plan/services/meal-plan-generator.service.ts
    src/app/features/meal-plan/components/category-config/category-config.component.ts
    src/app/features/meal-plan/components/category-config/category-config.component.html
  </files>
  <action>
**MealPlanGeneratorService (`meal-plan-generator.service.ts`):**

Create an injectable service with the following:

Inject `DishService` and `MealPlanService`.

**Core method: `generateWeeklyPlan(weekStart: string): Promise<GenerationResult>`**

Returns `GenerationResult` interface:
```typescript
interface GenerationResult {
  assignments: Map<DayOfWeek, Dish>;
  warnings: string[]; // e.g., "Nicht genugend Gerichte fur volle Abwechslung"
}
```

Algorithm (greedy randomized, as recommended by research):

1. Load inputs:
   - All user dishes via `DishService.getAll()`
   - Category preferences via `MealPlanService.getCategoryPreferences()`
   - Recent dish IDs (last 2 weeks) via `MealPlanService.getRecentDishIds(weekStart, 2)`

2. Filter available dishes:
   - Start with all dishes
   - Remove dishes in recentDishIds set (repeat avoidance)
   - If filtering leaves fewer dishes than 7: add back recent dishes but set `warnings.push('Nicht genugend Gerichte fur volle Abwechslung')`
   - Track `availableByCategory: Map<DishCategory, Dish[]>` split into favorites and non-favorites

3. Phase 1 -- Fill category requirements:
   - For each category with count > 0 in preferences:
     - Get available dishes for that category
     - Separate into favorites and non-favorites
     - Select using weighted random: favorites are 3x more likely to be picked (use weighted pool: add each favorite 3 times, each non-favorite 1 time, then Fisher-Yates shuffle and take N)
     - If insufficient dishes for this category's count: fill what's possible, add warning
     - Assign selected dishes to random unassigned days (shuffle day order)
     - Remove assigned dishes from all pools (avoid same dish twice in one week)

4. Phase 2 -- Fill remaining days (leftover slots):
   - Count unassigned days (7 minus already assigned)
   - Pool: all remaining available dishes regardless of category
   - Apply same favorite-weighted selection
   - Assign to remaining empty days

5. Phase 3 -- Fallback if insufficient dishes:
   - If still empty days remain: allow repeats from the full dish library (ignoring recent filter)
   - Ensure warning is set

Return the assignments map and warnings array.

**Helper functions (private):**
- `weightedRandomSample(dishes: Dish[], count: number): Dish[]` -- Fisher-Yates shuffle with favorite weighting (favorites appear 3x in the pool). Returns `count` unique dishes (deduplicate after weighting).
- `shuffleArray<T>(array: T[]): T[]` -- Fisher-Yates shuffle (in-place)

**CategoryConfigComponent (`category-config.component.ts`):**

Create a standalone component that can be shown inline (collapsible section) in the calendar page.

- Inject `MealPlanService` for loading/saving preferences
- On init: load preferences via `MealPlanService.getCategoryPreferences()`
- Inject `DishService` to show available dish counts per category
- State signals: `preferences` (Record<DishCategory, number>), `availableCounts` (Record<DishCategory, number>), `isSaving`, `totalConfigured` (computed: sum of all category counts)
- Computed signal `remainingDays`: 7 - totalConfigured (shows how many days will be "frei"/any category)
- Methods:
  - `updateCount(category: DishCategory, value: number)`: update preference, clamp 0-7, auto-save
  - `savePreferences()`: call `MealPlanService.saveCategoryPreferences(preferences())`

**Template (`category-config.component.html`):**
- Section header: "Kategorie-Verteilung" (bold)
- For each category (Fisch, Fleisch, Vegetarisch):
  - Category name with matching colored badge (same colors as Gerichte page)
  - Number input (type="number", min=0, max=7, step=1) showing current count
  - Available dish count hint: "(X verfugbar)" in muted text next to the input
  - Warning icon if configured count > available dishes for that category
- Summary line: "X Tage nach Kategorie, Y Tage frei" (where Y = 7 - sum of counts)
- Warning text if total > 7: "Summe ubersteigt 7 Tage" in red
- All German text
- Use Tailwind for styling, compact layout (each category on one row)
  </action>
  <verify>
Run `npx ng build` to verify TypeScript compilation. Then verify:
- MealPlanGeneratorService exists and exports the class
- Has generateWeeklyPlan method that returns GenerationResult
- Algorithm loads dishes, preferences, and recent dish IDs
- Favorite weighting is implemented (not binary filter)
- Repeat avoidance queries last 2 weeks
- Small library fallback generates warning string
- CategoryConfigComponent exists with number inputs per category
- Available dish counts shown next to inputs
- Build succeeds with zero errors
  </verify>
  <done>Generation algorithm handles category balance, favorite preference (3x weight), repeat avoidance (2 weeks), and small library fallback. Category config component lets users set per-category counts with live feedback on available dishes.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate generation and config into the weekly calendar component</name>
  <files>
    src/app/features/meal-plan/meal-plan.component.ts
    src/app/features/meal-plan/meal-plan.component.html
  </files>
  <action>
Update the MealPlanComponent to integrate the generation algorithm and category config.

**Component class updates:**
- Inject `MealPlanGeneratorService`
- Add state signals:
  - `isGenerating: WritableSignal<boolean>` (for loading state during generation)
  - `generationWarnings: WritableSignal<string[]>` (for displaying warnings after generation)
  - `showCategoryConfig: WritableSignal<boolean>` (toggle for showing/hiding category config section, default false)
- Add methods:
  - `generatePlan()`:
    1. If assignments map is not empty, show confirmation: use `window.confirm('Bestehende Eintrage uberschreiben?')` -- per user decision from CONTEXT.md
    2. Set `isGenerating(true)`
    3. Call `MealPlanGeneratorService.generateWeeklyPlan(currentWeekStart())`
    4. Get or create weekly plan via `MealPlanService.getOrCreateWeeklyPlan(currentWeekStart())`
    5. Clear existing assignments via `MealPlanService.clearWeekAssignments(planId)`
    6. Save all 7 assignments via `MealPlanService.assignDish()` for each day
    7. Update the assignments signal with the new plan (optimistic: update UI after algorithm runs but before save completes; rollback on save error)
    8. Set `generationWarnings` from result
    9. Set `isGenerating(false)`
    10. On error: show snackbar "Fehler beim Generieren", reset isGenerating
  - `regeneratePlan()`: same as `generatePlan()` (alias or same method -- always shows confirmation if assignments exist)
  - `toggleCategoryConfig()`: toggle showCategoryConfig signal

**Template updates:**
- **Generate button area** (replace the disabled placeholder from Plan 02):
  - Primary action button: "Plan generieren" (prominent, green background matching app theme)
  - Show spinner/loading indicator when `isGenerating()` is true
  - Disable button when `isGenerating()` or `isPastWeek()`
  - If plan already has assignments: button text changes to "Neu generieren" with a refresh icon
  - Button placement: above the day cards, below the category distribution summary

- **Category config section:**
  - Gear/settings icon button next to the generate button: "Verteilung anpassen"
  - Clicking toggles `showCategoryConfig` to show/hide the `CategoryConfigComponent` inline
  - Wrap in `@if (showCategoryConfig())` block
  - Add the CategoryConfigComponent to the component's imports array

- **Generation warnings display:**
  - Below the generate button, show `@if (generationWarnings().length > 0)` block
  - Each warning as a yellow/amber banner with warning icon
  - Text: display each warning string (e.g., "Nicht genugend Gerichte fur volle Abwechslung")
  - Dismissible (clear warnings on click)

- **Loading state during generation:**
  - Day cards show subtle pulse/skeleton animation while `isGenerating()` is true
  - Or simply disable interaction and show spinner on the generate button

- Add `CategoryConfigComponent` and `MealPlanGeneratorService` to imports/providers as needed.

**Important:** Do NOT break existing manual assignment functionality from Plan 02. The generate button adds to the existing UI, it does not replace manual operations.
  </action>
  <verify>
Run `npx ng build` to verify TypeScript compilation. Then verify:
- MealPlanComponent imports MealPlanGeneratorService
- Template has generate/regenerate button that is NOT disabled (was placeholder in Plan 02)
- Template has category config toggle button
- Template has CategoryConfigComponent in @if block
- Template has generation warnings display area
- Confirmation dialog text matches "Bestehende Eintrage uberschreiben?"
- Generate button shows loading state during generation
- Button text changes between "Plan generieren" and "Neu generieren" based on existing assignments
- Build succeeds with zero errors
- Manual assignment from Plan 02 still works (dish picker, swap, clear)
  </verify>
  <done>Generate button creates a complete weekly plan respecting category balance, favorite preference, and repeat avoidance. Category config UI allows users to customize distribution. Regeneration shows confirmation dialog. Warnings display when dish library is insufficient. All manual operations from Plan 02 remain functional.</done>
</task>

</tasks>

<verification>
1. `npx ng build` succeeds with zero errors
2. Generation algorithm produces 7 assignments respecting category preferences
3. Favorites are weighted higher (not exclusive) in generation
4. Recent dishes (last 2 weeks) are avoided when possible
5. Small library fallback shows warning and still generates a plan
6. Category config UI shows number inputs with available dish counts
7. Generate button triggers full plan creation with persistence
8. Regeneration shows "Bestehende Eintrage uberschreiben?" confirmation
9. Loading state visible during generation
10. Manual assignment (from Plan 02) still works alongside generation
</verification>

<success_criteria>
- One-click generation fills all 7 days of the week
- Category balance matches user configuration (e.g., 2x Fleisch, 2x Vegetarisch, 1x Fisch, 2 frei)
- Favorite dishes appear more frequently in generated plans
- Dishes from previous 2 weeks are avoided (when library permits)
- Users can configure how many of each category per week
- Insufficient dish warning appears when library is too small
- Confirmation dialog protects existing plans from accidental overwrite
- Both manual assignment and auto-generation coexist seamlessly
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-03-SUMMARY.md`
</output>
