---
phase: 03-meal-planning
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/app/features/meal-plan/meal-plan.component.ts
  - src/app/features/meal-plan/meal-plan.component.html
  - src/app/features/meal-plan/meal-plan.component.css
  - src/app/features/meal-plan/components/dish-picker/dish-picker.component.ts
  - src/app/features/meal-plan/components/dish-picker/dish-picker.component.html
autonomous: true
requirements: [PLAN-01, PLAN-06]
must_haves:
  truths:
    - "User sees a Monday-to-Sunday weekly calendar with a card for each day"
    - "Each day card shows the day name with actual calendar date (e.g., Montag, 17. Feb)"
    - "Assigned days show dish name, category badge (matching Gerichte page colors), and favorite indicator"
    - "Empty days show 'Kein Gericht' in muted text and are tappable to assign a dish"
    - "Tapping an empty day opens a dish picker bottom sheet with category filter chips"
    - "Filled days show a swap/edit icon that opens the same dish picker"
    - "Clear action available to remove a dish from a filled day"
    - "User can navigate between current week and next week"
    - "Past weeks are viewable in read-only mode"
    - "Category distribution summary shows count per category for the week"
  artifacts:
    - path: "src/app/features/meal-plan/meal-plan.component.ts"
      provides: "Weekly calendar UI with week navigation, day cards, and assignment management"
      min_lines: 120
    - path: "src/app/features/meal-plan/meal-plan.component.html"
      provides: "Calendar template with day cards, navigation, and distribution summary"
      min_lines: 100
    - path: "src/app/features/meal-plan/components/dish-picker/dish-picker.component.ts"
      provides: "Bottom sheet dish picker with category filtering"
      min_lines: 40
    - path: "src/app/features/meal-plan/components/dish-picker/dish-picker.component.html"
      provides: "Dish picker template with category chips and dish list"
      min_lines: 30
  key_links:
    - from: "src/app/features/meal-plan/meal-plan.component.ts"
      to: "src/app/features/meal-plan/services/meal-plan.service.ts"
      via: "inject(MealPlanService)"
      pattern: "inject\\(MealPlanService\\)"
    - from: "src/app/features/meal-plan/meal-plan.component.ts"
      to: "src/app/features/meal-plan/components/dish-picker/dish-picker.component.ts"
      via: "MatBottomSheet.open(DishPickerComponent)"
      pattern: "MatBottomSheet"
    - from: "src/app/features/meal-plan/components/dish-picker/dish-picker.component.ts"
      to: "src/app/features/dishes/services/dish.service.ts"
      via: "inject(DishService)"
      pattern: "inject\\(DishService\\)"
    - from: "src/app/features/meal-plan/meal-plan.component.ts"
      to: "src/app/features/meal-plan/models/meal-plan.model.ts"
      via: "import types and helpers"
      pattern: "import.*from.*meal-plan\\.model"
---

<objective>
Build the weekly calendar UI with day cards, week navigation, dish picker bottom sheet, and manual dish assignment/swap/clear functionality.

Purpose: Deliver the primary user-facing interface for viewing and manually managing weekly meal plans. This is the visible core of Phase 3 -- users can see their week and manually assign dishes before automation is added in Plan 03.

Output: Fully functional weekly calendar at /wochenplan with dish picker bottom sheet for assigning, swapping, and clearing meals.
</objective>

<execution_context>
@C:/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-CONTEXT.md
@.planning/phases/03-meal-planning/03-RESEARCH.md
@.planning/phases/03-meal-planning/03-01-SUMMARY.md
@src/app/features/meal-plan/models/meal-plan.model.ts
@src/app/features/meal-plan/services/meal-plan.service.ts
@src/app/features/dishes/services/dish.service.ts
@src/app/features/dishes/models/dish.model.ts
@src/app/features/dishes/dishes.component.ts
@src/app/features/dishes/dishes.component.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DishPickerComponent as Angular Material bottom sheet</name>
  <files>
    src/app/features/meal-plan/components/dish-picker/dish-picker.component.ts
    src/app/features/meal-plan/components/dish-picker/dish-picker.component.html
  </files>
  <action>
Create a standalone component that works as an Angular Material bottom sheet for selecting a dish.

**Component class:**
- Inject `DishService` to load user's dishes
- Inject `MatBottomSheetRef` to close sheet and return selected dish
- Accept optional data via `MAT_BOTTOM_SHEET_DATA` injection token: `{ currentDishId?: string }` (to indicate which dish is currently assigned, if any)
- On init, load all dishes via `DishService.getAll()`
- State signals: `allDishes`, `activeFilter` (alle/Fisch/Fleisch/Vegetarisch/Favoriten), `isLoading`
- Computed signal `filteredDishes` that filters by active category (reuse the filtering pattern from DishesComponent)
- Method `selectDish(dish: Dish)`: closes bottom sheet and returns the selected dish via `bottomSheetRef.dismiss(dish)`
- Method `setFilter(category: string)`: updates activeFilter signal
- Method `clear()`: closes bottom sheet and returns `null` (for removing a dish)

**Template:**
- Header: "Gericht auswahlen" (bold, with close X button)
- If `currentDishId` is provided, show a "Gericht entfernen" button at top (red text, calls `clear()`)
- Category filter chips in a horizontal scrollable row: Alle | Fisch | Fleisch | Vegetarisch | Favoriten
  - Active chip: green background (matching Gerichte tab style)
  - Use the same chip style as the Gerichte page tabs for visual consistency
- Scrollable dish list below filters:
  - Each dish row shows: name, category badge (use SAME Tailwind colors as Gerichte page: blue=Fisch, red=Fleisch, green=Vegetarisch), favorite heart indicator
  - Currently assigned dish (if any) gets a checkmark or highlighted border
  - Tap entire row to select (`selectDish(dish)`)
- Loading state: "Laden..." while dishes load
- Empty state: "Keine Gerichte in dieser Kategorie" if filtered list is empty
- Max height of bottom sheet: 70vh with overflow-y-auto for scrolling
- German text throughout
  </action>
  <verify>
Run `npx ng build` to verify TypeScript compilation. Then verify:
- Component file exists and exports DishPickerComponent
- Uses MAT_BOTTOM_SHEET_DATA and MatBottomSheetRef
- Injects DishService for loading dishes
- Has category filter chips in template
- Category badge colors match Gerichte page (blue=Fisch, red=Fleisch, green=Vegetarisch)
- Has clear/remove action when currentDishId is provided
  </verify>
  <done>DishPickerComponent builds without errors. It loads dishes, filters by category, shows matching category colors, and returns the selected dish (or null for clear) when dismissed.</done>
</task>

<task type="auto">
  <name>Task 2: Implement weekly calendar view with day cards, navigation, and manual assignment</name>
  <files>
    src/app/features/meal-plan/meal-plan.component.ts
    src/app/features/meal-plan/meal-plan.component.html
    src/app/features/meal-plan/meal-plan.component.css
  </files>
  <action>
Replace the placeholder MealPlanComponent with the full weekly calendar implementation.

**Component class:**
- Inject `MealPlanService`, `DishService`, `MatBottomSheet`, `MatSnackBar`
- State signals:
  - `currentWeekStart: WritableSignal<string>` -- ISO date string of current week's Monday (initialize with `getWeekStart(new Date())`)
  - `assignments: WritableSignal<Map<DayOfWeek, MealAssignment>>` -- map of day -> assignment for current week
  - `isLoading: WritableSignal<boolean>`
  - `weeklyPlanId: WritableSignal<string | null>` -- ID of the current weekly_plan record
- Computed signals:
  - `weekDates: Signal<string[]>` -- array of 7 date strings from `getWeekDates(currentWeekStart())`
  - `dayCards: Signal<DayCard[]>` -- array of 7 objects with { dayOfWeek, dayLabel (e.g., "Montag, 17. Feb"), assignment (MealAssignment | null), isToday, date }
  - `categoryDistribution: Signal<Record<string, number>>` -- count of each category in current week's assignments (for summary bar)
  - `isCurrentOrFutureWeek: Signal<boolean>` -- true if current view is this week or next week (allows editing)
  - `isPastWeek: Signal<boolean>` -- true if viewing a past week (read-only)
  - `canGoBack: Signal<boolean>` -- allow navigating to past (always true -- past weeks are read-only viewable)
  - `canGoForward: Signal<boolean>` -- only allow navigating to current + 1 week ahead (per user decision)
- On init (and when `currentWeekStart` changes via effect): call `loadWeek()`
- `loadWeek()`: call `MealPlanService.getAssignmentsForWeek(currentWeekStart())`, build the assignments Map from the array result
- `navigateWeek(direction: -1 | 1)`: add/subtract 7 days from currentWeekStart, reformat to ISO string
- `openDishPicker(dayOfWeek: DayOfWeek)`: If isPastWeek, do nothing. Open `MatBottomSheet` with `DishPickerComponent`, passing `{ currentDishId: assignments().get(dayOfWeek)?.dish_id }`. On dismiss:
  - If result is a Dish: call `assignDish(dayOfWeek, dish)` with optimistic update
  - If result is null: call `removeDish(dayOfWeek)` with optimistic update
  - If result is undefined (dismissed without action): do nothing
- `assignDish(dayOfWeek, dish)`: Optimistic update of assignments signal, then `MealPlanService.getOrCreateWeeklyPlan()` (if no plan exists yet) then `MealPlanService.assignDish()`. Rollback on error with snackbar.
- `removeDish(dayOfWeek)`: Optimistic remove from assignments, then `MealPlanService.removeDish()`. Rollback on error.

**Template structure:**
1. **Week header:** Left arrow | "KW {weekNumber} - {dateRange}" (e.g., "KW 8 - 16. Feb. - 22. Feb. 2026") | Right arrow
   - Left arrow always enabled (past weeks viewable)
   - Right arrow disabled when already at max future week (current + 1)
   - Show "(Nur Ansicht)" badge when viewing past weeks
2. **Category distribution summary bar:** Horizontal row showing "2x Fleisch, 1x Fisch, 2x Vegetarisch, 2x frei" based on actual assignments. Use matching category badge colors. Show below header.
3. **Day cards (7x, Monday to Sunday):**
   - Each card is a full-width row (mobile) or grid cell (desktop: 7-column grid)
   - Day label: "Montag, 17. Feb" (bold)
   - If today: subtle highlight (e.g., left border accent or light green background)
   - **If assigned:**
     - Dish name (medium weight text)
     - Category badge (colored pill matching Gerichte page: blue=Fisch, red=Fleisch, green=Vegetarisch)
     - Favorite heart icon (filled red if favorite, outline if not) -- display only, not toggleable
     - Swap/edit icon button (pencil or swap icon) -- opens dish picker (only if NOT past week)
   - **If empty:**
     - "Kein Gericht" in muted gray text
     - Tap the whole card to open dish picker (only if NOT past week)
   - Past week days: no edit icons, muted appearance, no tap handler
4. **Placeholder for generate button** (bottom of page, just show disabled button with text "Plan generieren" -- will be activated in Plan 03). This ensures the UI shows where generation will live.

**Styling (meal-plan.component.css or Tailwind in template):**
- Mobile-first: vertical stack of day cards (each full width)
- Desktop (md+): 7-column grid layout for day cards OR keep vertical list with wider cards (use Claude's discretion)
- Category badge colors MUST match Gerichte page exactly: `bg-blue-100 text-blue-800` (Fisch), `bg-red-100 text-red-800` (Fleisch), `bg-green-100 text-green-800` (Vegetarisch)
- Card hover effect on editable days (subtle shadow increase)
- Today highlight: left border with `border-l-4 border-green-500` or similar
- Page container: `p-4 max-w-4xl mx-auto` matching Gerichte page
- Navigation arrows: 44px touch target minimum

**Imports:** Add `MatBottomSheetModule` and `MatSnackBarModule` to component imports array. Import the DishPickerComponent.
  </action>
  <verify>
Run `npx ng build` to verify TypeScript compilation. Then verify:
- MealPlanComponent imports MealPlanService and MatBottomSheet
- Template has 7 day cards with day labels including dates
- Template has week navigation arrows
- Template has category distribution summary
- Template has "Kein Gericht" text for empty days
- Category badge colors match Gerichte page (blue, red, green)
- Template has dish picker bottom sheet integration
- Past week detection disables editing
- Build succeeds with zero errors
  </verify>
  <done>Weekly calendar shows Mon-Sun day cards with dates, allows manual dish assignment via bottom sheet picker, supports swapping and clearing dishes, navigates between weeks, shows past weeks as read-only, and displays category distribution summary. Build passes.</done>
</task>

</tasks>

<verification>
1. `npx ng build` succeeds with zero errors
2. DishPickerComponent exists as standalone bottom sheet component
3. MealPlanComponent displays 7 day cards with actual calendar dates
4. Week navigation works (current week and next week editable, past weeks read-only)
5. Category badge colors match Gerichte page exactly
6. Category distribution summary appears with accurate counts
7. Dish picker opens on tap with category filter chips
8. Assignment, swap, and clear operations use optimistic updates
</verification>

<success_criteria>
- User sees Monday-to-Sunday calendar with day labels including dates
- Empty days show "Kein Gericht" and are tappable (non-past weeks)
- Tapping opens dish picker bottom sheet with category filtering
- Selecting a dish assigns it to the day with optimistic UI update
- Filled days show dish name + category badge (matching colors) + favorite indicator
- Swap/edit icon on filled days opens dish picker for replacement
- Clear action removes a dish from a day
- Week navigation shows current and next week (editable) and past weeks (read-only)
- Category distribution summary shows count per category
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-02-SUMMARY.md`
</output>
