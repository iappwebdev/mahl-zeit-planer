<div class="p-4 max-w-4xl mx-auto">

  <!-- Week Navigation Header -->
  <div class="flex items-center justify-between mb-5">

    <!-- Left arrow (always enabled ‚Äî past weeks are viewable) -->
    <button
      type="button"
      (click)="navigateWeek(-1)"
      class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg transition-colors nav-button"
      aria-label="Vorherige Woche"
    >
      <lucide-icon [img]="ChevronLeft" [size]="24" class="text-secondary"></lucide-icon>
    </button>

    <!-- Week label -->
    <div class="flex flex-col items-center gap-1.5">
      <span class="font-bold text-primary text-base text-center" style="letter-spacing: -0.01em;">{{ weekHeaderLabel() }}</span>
      @if (isPastWeek()) {
        <span class="text-xs font-semibold px-3 py-1 rounded-full" style="background-color: var(--bg-surface); color: var(--text-tertiary);">Nur Ansicht</span>
      }
    </div>

    <!-- Right arrow (disabled when at max future week) -->
    <button
      type="button"
      (click)="navigateWeek(1)"
      [disabled]="!canGoForward()"
      class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg transition-colors nav-button"
      [class.opacity-30]="!canGoForward()"
      [class.cursor-not-allowed]="!canGoForward()"
      aria-label="N√§chste Woche"
    >
      <lucide-icon [img]="ChevronRight" [size]="24" class="text-secondary"></lucide-icon>
    </button>

  </div>

  <!-- Category Distribution Summary -->
  <div class="flex flex-wrap gap-2 mb-5">
    @if (isLoading()) {
      <span class="text-sm text-muted">Lade Wochenplan...</span>
    } @else if (distributionSummary().length > 0) {
      @for (item of distributionSummary(); track item.label) {
        <span [class]="'px-3 py-1.5 rounded-full text-sm font-semibold distribution-badge ' + item.colorClass">
          {{ item.label }}
        </span>
      }
    } @else {
      <span class="text-sm text-muted">Noch keine Gerichte diese Woche</span>
    }
  </div>

  <!-- Generate Plan Button + Settings Toggle -->
  @if (!isPastWeek()) {
    <div class="mb-5">

      <!-- Button row -->
      <div class="flex items-center gap-2">

        <!-- Primary generate button -->
        <button
          type="button"
          (click)="generatePlan()"
          [disabled]="isGenerating() || isPastWeek()"
          class="flex-1 px-6 py-3.5 rounded-xl font-bold text-white transition-all flex items-center justify-center gap-2 generate-button"
          [class.cursor-not-allowed]="isGenerating()"
        >
          @if (isGenerating()) {
            <!-- Spinner -->
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            Generiere...
          } @else if (hasExistingAssignments()) {
            <lucide-icon [img]="Sparkles" [size]="20"></lucide-icon>
            Neu generieren
          } @else {
            <lucide-icon [img]="Sparkles" [size]="20"></lucide-icon>
            Plan generieren
          }
        </button>

        <!-- Settings / gear toggle button -->
        <button
          type="button"
          (click)="toggleCategoryConfig()"
          class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl border transition-all settings-button"
          [class.settings-active]="showCategoryConfig()"
          title="Kategorie-Verteilung anpassen"
          aria-label="Verteilung anpassen"
        >
          <lucide-icon [img]="Settings" [size]="20"></lucide-icon>
        </button>

      </div>

      <!-- Category config panel (collapsible) -->
      @if (showCategoryConfig()) {
        <div class="mt-3">
          <app-category-config />
        </div>
      }

      <!-- Generation warnings -->
      @if (generationWarnings().length > 0) {
        <div class="mt-3 space-y-2">
          @for (warning of generationWarnings(); track warning) {
            <div class="flex items-center gap-2 rounded-xl px-4 py-3 warning-box" style="background-color: var(--warning-bg); border: 1px solid var(--warning);">
              <lucide-icon [img]="AlertTriangle" [size]="20" class="flex-shrink-0" style="color: var(--warning);"></lucide-icon>
              <span class="text-sm font-medium flex-1" style="color: var(--warning);">{{ warning }}</span>
              <button
                type="button"
                (click)="dismissWarnings()"
                class="flex-shrink-0 p-1 rounded transition-colors"
                style="color: var(--warning);"
                aria-label="Warnung schliessen"
              >
                <lucide-icon [img]="X" [size]="16"></lucide-icon>
              </button>
            </div>
          }
        </div>
      }

    </div>
  }

  <!-- Day Cards -->
  <div class="space-y-3">
    @for (card of dayCards(); track card.dayOfWeek) {

      @if (card.assignment) {
        <!-- Filled Day Card -->
        <div
          class="bg-surface rounded-xl shadow-card p-4 transition-all day-card"
          [class.today-card]="card.isToday"
          [class.opacity-60]="isGenerating()"
          [class.hover:shadow-card-hover]="isCurrentOrFutureWeek()"
        >
          <div class="flex items-center gap-3">

            <!-- Day label -->
            <div class="flex-1 min-w-0">
              <div class="font-bold text-sm mb-1.5 day-label" style="color: var(--text-tertiary); letter-spacing: 0.02em; text-transform: uppercase;">{{ card.dayLabel }}</div>
              <div class="flex items-center gap-2 flex-wrap">
                <!-- Dish name -->
                <span class="font-semibold text-base truncate" style="color: var(--text-primary);">{{ card.assignment.dish?.name }}</span>

                <!-- Category badge -->
                <span
                  class="px-2.5 py-1 rounded-full text-xs font-semibold flex-shrink-0"
                  [class.category-fish]="card.assignment.dish?.category === 'Fisch'"
                  [class.category-meat]="card.assignment.dish?.category === 'Fleisch'"
                  [class.category-veg]="card.assignment.dish?.category === 'Vegetarisch'"
                >
                  @if (card.assignment.dish?.category === 'Fisch') { üêü }
                  @if (card.assignment.dish?.category === 'Fleisch') { ü•© }
                  @if (card.assignment.dish?.category === 'Vegetarisch') { ü•¨ }
                </span>

                <!-- Favorite heart (display only) -->
                @if (card.assignment.dish?.is_favorite) {
                  <svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
                  </svg>
                }
              </div>
            </div>

            <!-- Swap/edit icon (only for editable weeks) -->
            @if (isCurrentOrFutureWeek()) {
              <button
                type="button"
                (click)="openDishPicker(card.dayOfWeek)"
                [disabled]="isGenerating()"
                class="p-2 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center flex-shrink-0 swap-button"
                aria-label="Gericht tauschen"
              >
                <lucide-icon [img]="ArrowLeftRight" [size]="20" class="text-secondary"></lucide-icon>
              </button>
            }

          </div>
        </div>

      } @else {
        <!-- Empty Day Card -->
        <div
          class="bg-surface rounded-xl shadow-card p-4 transition-all day-card empty-card"
          [class.today-card]="card.isToday"
          [class.opacity-60]="isGenerating()"
          [class.hover:shadow-card-hover]="isCurrentOrFutureWeek()"
          [class.cursor-pointer]="isCurrentOrFutureWeek() && !isGenerating()"
          (click)="openDishPicker(card.dayOfWeek)"
        >
          <div class="flex items-center gap-3">

            <!-- Day label + empty indicator -->
            <div class="flex-1">
              <div class="font-bold text-sm mb-1.5 day-label" style="color: var(--text-tertiary); letter-spacing: 0.02em; text-transform: uppercase;">{{ card.dayLabel }}</div>
              @if (isGenerating()) {
                <div class="h-4 rounded animate-pulse w-32" style="background-color: var(--bg-surface-hover);"></div>
              } @else {
                <div class="text-sm italic" style="color: var(--text-muted);">Kein Gericht</div>
              }
            </div>

            <!-- Plus icon (only for editable weeks, not while generating) -->
            @if (isCurrentOrFutureWeek() && !isGenerating()) {
              <div class="p-2 min-w-[44px] min-h-[44px] flex items-center justify-center flex-shrink-0">
                <lucide-icon [img]="Plus" [size]="20" style="color: var(--text-muted);"></lucide-icon>
              </div>
            }

          </div>
        </div>
      }

    }
  </div>

</div>

<style>
  .nav-button:hover {
    background-color: var(--bg-surface-hover);
  }

  .generate-button {
    background-color: var(--brand-primary);
    box-shadow: var(--shadow-sm);
  }

  .generate-button:hover:not(:disabled) {
    background-color: var(--brand-hover);
    box-shadow: var(--shadow-md);
  }

  .generate-button:disabled {
    background-color: var(--brand-primary);
    opacity: 0.6;
  }

  .settings-button {
    border-color: var(--border-standard);
    color: var(--text-tertiary);
  }

  .settings-button:hover {
    background-color: var(--bg-surface-hover);
  }

  .settings-active {
    background-color: var(--brand-subtle) !important;
    border-color: var(--brand-primary) !important;
    color: var(--brand-primary) !important;
  }

  .day-card {
    position: relative;
  }

  .today-card {
    border-left: 4px solid var(--brand-primary);
  }

  .category-fish {
    background-color: var(--ocean-100);
    color: var(--ocean-600);
  }

  .category-meat {
    background-color: var(--coral-100);
    color: var(--coral-600);
  }

  .category-veg {
    background-color: var(--sage-100);
    color: var(--sage-600);
  }

  .swap-button:hover {
    background-color: var(--bg-surface-hover);
  }
</style>
